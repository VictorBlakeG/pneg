<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-N Junction Fermi Level Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .controls {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }
        
        select, input[type="range"] {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        .info-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .info-panel h3 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.125rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 500px;
        }
        
        .chart-info {
            text-align: center;
            margin-top: 20px;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .help-panel {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
        }
        
        .help-panel h4 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .help-panel ul {
            list-style: disc;
            margin-left: 20px;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .help-panel li {
            margin-bottom: 6px;
        }
        
        .calc-section {
            margin-bottom: 30px;
        }
        
        .calc-section h3 {
            color: #1f2937;
            font-size: 1.25rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2563eb;
        }
        
        .calc-section h4 {
            color: #374151;
            font-size: 1rem;
            margin: 18px 0 10px 0;
        }
        
        .calc-step {
            background: #f8fafc;
            border-left: 3px solid #2563eb;
            padding: 12px 16px;
            margin: 10px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            line-height: 1.7;
            overflow-x: auto;
        }
        
        .calc-step .formula {
            color: #1e40af;
            font-weight: 600;
        }
        
        .calc-step .substitution {
            color: #374151;
        }
        
        .calc-step .result {
            color: #059669;
            font-weight: 700;
        }
        
        .calc-step .label {
            color: #6b7280;
            font-style: italic;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .settings-table, .constants-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0 20px 0;
            font-size: 0.875rem;
        }
        
        .settings-table td, .constants-table td {
            padding: 6px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .settings-table td:first-child, .constants-table td:first-child {
            font-weight: 600;
            color: #374151;
            width: 40%;
        }
        
        .settings-table td:last-child, .constants-table td:last-child {
            font-family: 'Courier New', Courier, monospace;
            color: #1f2937;
        }
        
        .calc-divider {
            border: none;
            border-top: 1px dashed #d1d5db;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .info-panels {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>P-N Junction Fermi Level Simulator</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="material">Substrate Material</label>
                <select id="material">
                    <option value="Si">Silicon (Si)</option>
                    <option value="GaAs">Gallium Arsenide (GaAs)</option>
                    <option value="Ge">Germanium (Ge)</option>
                    <option value="GaN">Gallium Nitride (GaN)</option>
                    <option value="InP">Indium Phosphide (InP)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="temperature">Temperature: <span id="tempValue">300</span> K</label>
                <input type="range" id="temperature" min="0" max="700" value="300">
            </div>
            
            <div class="control-group">
                <label for="nDopant">N-type Dopant</label>
                <select id="nDopant"></select>
            </div>
            
            <div class="control-group">
                <label for="pDopant">P-type Dopant</label>
                <select id="pDopant"></select>
            </div>
            
            <div class="control-group">
                <label for="nConc">N<sub>D</sub>: <span id="nConcValue">1.00e+16</span> cm⁻³</label>
                <input type="range" id="nConc" min="14" max="19" step="0.1" value="16">
            </div>
            
            <div class="control-group">
                <label for="pConc">N<sub>A</sub>: <span id="pConcValue">1.00e+16</span> cm⁻³</label>
                <input type="range" id="pConc" min="14" max="19" step="0.1" value="16">
            </div>
            
            <div class="control-group">
                <label for="forwardBias">Forward Bias: <span id="biasValue">0.000</span> V</label>
                <input type="range" id="forwardBias" min="0" max="1" step="0.01" value="0">
            </div>
            
            <div class="control-group checkbox-group">
                <input type="checkbox" id="showQuasiFermi">
                <label for="showQuasiFermi">Show Quasi-Fermi Levels</label>
            </div>
            
            <div class="control-group checkbox-group">
                <input type="checkbox" id="showCalculations">
                <label for="showCalculations">Show Calculations</label>
            </div>
        </div>
        
        <div class="info-panels">
            <div class="info-panel">
                <h3>Varshni Parameters & Results</h3>
                <div class="info-grid" id="varshniInfo"></div>
            </div>
            
            <div class="info-panel">
                <h3>Energy Levels (eV)</h3>
                <div class="info-grid" id="energyInfo"></div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="text-align: center; color: #1f2937; margin-bottom: 20px;">Energy Band Diagram</h3>
            <div class="chart-wrapper">
                <canvas id="bandChart"></canvas>
            </div>
            <div class="chart-info" id="chartInfo"></div>
        </div>
        
        <div class="chart-container">
            <h3 style="text-align: center; color: #1f2937; margin-bottom: 20px;">Electrostatic Potential &amp; Electric Field</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="potentialChart"></canvas>
                </div>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="efieldChart"></canvas>
                </div>
            </div>
            <div class="chart-info" id="potentialChartInfo"></div>
        </div>
        
        <div id="calculationsSection" style="display: none;">
            <div class="chart-container">
                <div id="calculationsContent"></div>
            </div>
        </div>
        
        <div class="help-panel">
            <h4>Understanding the Diagram:</h4>
            <ul>
                <li><strong>Blue line (E<sub>c</sub>):</strong> Conduction band edge - electrons above this energy are mobile</li>
                <li><strong>Red line (E<sub>v</sub>):</strong> Valence band edge - holes below this energy are mobile</li>
                <li><strong>Purple dashed (E<sub>i</sub>):</strong> Intrinsic Fermi level - where Fermi level would be without doping</li>
                <li><strong>Green line (E<sub>F</sub>):</strong> Equilibrium Fermi level - constant throughout device at equilibrium</li>
                <li id="quasiFermiHelp" style="display: none;"><strong>Cyan/Orange dashed:</strong> Quasi-Fermi levels for electrons (E<sub>Fn</sub>) and holes (E<sub>Fp</sub>) under bias/illumination</li>
                <li><strong>Band bending:</strong> Shows the built-in electric field in the depletion region</li>
                <li><strong>φ(x) (Potential plot):</strong> Electrostatic potential across the junction showing φ<sub>bi</sub> (built-in potential). x-axis runs from −x<sub>p</sub> to x<sub>n</sub> with 0 at the metallurgical junction</li>
                <li><strong>E(x) (Electric field plot):</strong> Electric field in the depletion region, peaking at the junction. Triangular profile from the depletion approximation</li>
            </ul>
        </div>
    </div>
    
    <script>
        const MATERIALS = {
            Si: {
                name: 'Silicon',
                Eg0: 1.170,
                alpha: 4.73e-4,
                beta: 636,
                Nc: 2.8e19,
                Nv: 1.04e19,
                donors: ['P', 'As', 'Sb'],
                acceptors: ['B', 'Al', 'Ga', 'In'],
                donorEnergies: { P: 0.045, As: 0.054, Sb: 0.039 },
                acceptorEnergies: { B: 0.045, Al: 0.057, Ga: 0.065, In: 0.16 }
            },
            GaAs: {
                name: 'Gallium Arsenide',
                Eg0: 1.519,
                alpha: 5.41e-4,
                beta: 204,
                Nc: 4.7e17,
                Nv: 7.0e18,
                donors: ['Si', 'Ge', 'Sn', 'Se', 'Te'],
                acceptors: ['Si', 'Ge', 'Zn', 'Cd', 'Be', 'Mg'],
                donorEnergies: { Si: 0.0058, Ge: 0.006, Sn: 0.006, Se: 0.006, Te: 0.003 },
                acceptorEnergies: { Si: 0.035, Ge: 0.040, Zn: 0.031, Cd: 0.035, Be: 0.028, Mg: 0.028 }
            },
            Ge: {
                name: 'Germanium',
                Eg0: 0.7437,
                alpha: 4.77e-4,
                beta: 235,
                Nc: 1.04e19,
                Nv: 6.0e18,
                donors: ['P', 'As', 'Sb'],
                acceptors: ['B', 'Al', 'Ga', 'In'],
                donorEnergies: { P: 0.012, As: 0.013, Sb: 0.010 },
                acceptorEnergies: { B: 0.010, Al: 0.010, Ga: 0.011, In: 0.011 }
            },
            GaN: {
                name: 'Gallium Nitride',
                Eg0: 3.507,
                alpha: 9.14e-4,
                beta: 772,
                Nc: 2.3e18,
                Nv: 4.6e19,
                donors: ['Si', 'O', 'Ge'],
                acceptors: ['Mg', 'Zn', 'Cd', 'Be'],
                donorEnergies: { Si: 0.015, O: 0.029, Ge: 0.022 },
                acceptorEnergies: { Mg: 0.160, Zn: 0.340, Cd: 0.550, Be: 0.250 }
            },
            InP: {
                name: 'Indium Phosphide',
                Eg0: 1.421,
                alpha: 4.9e-4,
                beta: 327,
                Nc: 5.7e17,
                Nv: 1.1e19,
                donors: ['Si', 'S', 'Se', 'Sn', 'Te'],
                acceptors: ['Zn', 'Cd', 'Be', 'Mg'],
                donorEnergies: { Si: 0.007, S: 0.007, Se: 0.007, Sn: 0.007, Te: 0.007 },
                acceptorEnergies: { Zn: 0.040, Cd: 0.050, Be: 0.028, Mg: 0.040 }
            }
        };
        
        let chart = null;
        let potentialChart = null;
        let efieldChart = null;
        let currentMaterial = 'Si';
        
        function calculateBandgap(material, T) {
            const mat = MATERIALS[material];
            return mat.Eg0 - (mat.alpha * T * T) / (T + mat.beta);
        }
        
        function calculateNi(material, T) {
            const mat = MATERIALS[material];
            const Eg = calculateBandgap(material, T);
            const kT = 8.617e-5 * T;
            const Nc_T = mat.Nc * Math.pow(T / 300, 1.5);
            const Nv_T = mat.Nv * Math.pow(T / 300, 1.5);
            return Math.sqrt(Nc_T * Nv_T) * Math.exp(-Eg / (2 * kT));
        }
        
        function updateDopantOptions() {
            const mat = MATERIALS[currentMaterial];
            const nDopantSelect = document.getElementById('nDopant');
            const pDopantSelect = document.getElementById('pDopant');
            
            nDopantSelect.innerHTML = '';
            pDopantSelect.innerHTML = '';
            
            mat.donors.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = `${d} (Ed = ${mat.donorEnergies[d]} eV)`;
                nDopantSelect.appendChild(opt);
            });
            
            mat.acceptors.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = `${a} (Ea = ${mat.acceptorEnergies[a]} eV)`;
                pDopantSelect.appendChild(opt);
            });
        }
        
        function calculate() {
            const temperature = parseFloat(document.getElementById('temperature').value);
            const nConc = Math.pow(10, parseFloat(document.getElementById('nConc').value));
            const pConc = Math.pow(10, parseFloat(document.getElementById('pConc').value));
            const forwardBias = parseFloat(document.getElementById('forwardBias').value);
            const showQuasiFermi = document.getElementById('showQuasiFermi').checked;
            
            const mat = MATERIALS[currentMaterial];
            const Eg = calculateBandgap(currentMaterial, temperature);
            const kT = 8.617e-5 * temperature;
            const ni = calculateNi(currentMaterial, temperature);
            
            const Ev = 0;
            const Ec = Eg;
            const Ei = Eg / 2;
            
            const Ef_n = Ec - kT * Math.log(mat.Nc * Math.pow(temperature / 300, 1.5) / nConc);
            const Ef_p = Ev + kT * Math.log(mat.Nv * Math.pow(temperature / 300, 1.5) / pConc);
            
            const Vbi = Ef_n - Ef_p;
            
            const qV = forwardBias;
            const Efn_n = Ef_n;
            const Efp_p = Ef_p;
            const Efn_p = Ef_p + qV;
            const Efp_n = Ef_n - qV;
            
            return { Eg, Ev, Ec, Ei, Ef_n, Ef_p, Vbi, ni, Efn_n, Efp_p, Efn_p, Efp_n, kT, mat, temperature, nConc, pConc, forwardBias, showQuasiFermi };
        }
        
        // Physical constants
        const q = 1.602e-19;       // C
        const eps0 = 8.854e-12;    // F/m
        const eps_r = { Si: 11.7, GaAs: 12.9, Ge: 16.0, GaN: 8.9, InP: 12.5 };
        
        function calculateDepletionParams(calc) {
            const ND = calc.nConc * 1e6;  // convert cm^-3 to m^-3
            const NA = calc.pConc * 1e6;
            const eps = eps0 * eps_r[currentMaterial];
            const Vbi_eff = Math.max(calc.Vbi - calc.forwardBias, 0.001);
            
            // Total depletion width W
            const W = Math.sqrt(2 * eps * Vbi_eff / q * (1/NA + 1/ND));
            
            // Depletion into p-side and n-side
            const xp = W * ND / (NA + ND);  // metres
            const xn = W * NA / (NA + ND);  // metres
            
            // Peak electric field at junction
            const E_max = q * NA * xp / eps;  // V/m
            
            return { xp, xn, W, E_max, Vbi_eff, eps, ND, NA };
        }

        function createDepletionAnnotations(dep) {
            const xp_um = dep.xp * 1e6;  // Convert to micrometers
            const xn_um = dep.xn * 1e6;

            return {
                depletionXp: {
                    type: 'line',
                    xMin: -xp_um,
                    xMax: -xp_um,
                    borderColor: '#9333ea',
                    borderWidth: 1.5,
                    borderDash: [6, 4],
                    label: {
                        display: true,
                        content: `−xₚ = ${xp_um.toFixed(4)} μm`,
                        position: 'start',
                        backgroundColor: 'rgba(147, 51, 234, 0.8)',
                        color: 'white',
                        font: { size: 10, weight: 'bold' },
                        padding: 4
                    }
                },
                junction: {
                    type: 'line',
                    xMin: 0,
                    xMax: 0,
                    borderColor: '#059669',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    label: {
                        display: true,
                        content: 'Junction (x=0)',
                        position: 'start',
                        backgroundColor: 'rgba(5, 150, 105, 0.8)',
                        color: 'white',
                        font: { size: 10, weight: 'bold' },
                        padding: 4
                    }
                },
                depletionXn: {
                    type: 'line',
                    xMin: xn_um,
                    xMax: xn_um,
                    borderColor: '#2563eb',
                    borderWidth: 1.5,
                    borderDash: [6, 4],
                    label: {
                        display: true,
                        content: `+xₙ = ${xn_um.toFixed(4)} μm`,
                        position: 'start',
                        backgroundColor: 'rgba(37, 99, 235, 0.8)',
                        color: 'white',
                        font: { size: 10, weight: 'bold' },
                        padding: 4
                    }
                },
                depletionRegion: {
                    type: 'box',
                    xMin: -xp_um,
                    xMax: xn_um,
                    backgroundColor: 'rgba(156, 163, 175, 0.1)',
                    borderWidth: 0,
                    label: {
                        display: true,
                        content: `W = ${(dep.W * 1e6).toFixed(4)} μm`,
                        position: 'center',
                        color: '#6b7280',
                        font: { size: 9, style: 'italic' }
                    }
                }
            };
        }

        function updatePotentialChart(calc) {
            const dep = calculateDepletionParams(calc);
            const { xp, xn, Vbi_eff, eps, ND, NA } = dep;
            
            const points = 200;
            const margin = 0.3; // extra fraction beyond depletion edges
            const xMin = -xp * (1 + margin);
            const xMax = xn * (1 + margin);
            
            const positions = [];
            const phi_data = [];
            
            for (let i = 0; i <= points; i++) {
                const x = xMin + (xMax - xMin) * i / points;
                positions.push(x);
                
                let phi;
                
                if (x <= -xp) {
                    phi = 0;
                } else if (x <= 0) {
                    phi = (q * NA / (2 * eps)) * (x + xp) * (x + xp);
                } else if (x <= xn) {
                    phi = Vbi_eff - (q * ND / (2 * eps)) * (x - xn) * (x - xn);
                } else {
                    phi = Vbi_eff;
                }
                
                phi_data.push(phi);
            }
            
            // Convert positions to micrometres for readability
            const pos_um = positions.map(x => x * 1e6);
            const xp_um = xp * 1e6;
            const xn_um = xn * 1e6;
            
            // Compute E-field in V/cm
            const efield_Vcm = [];
            for (let i = 0; i <= points; i++) {
                const x = positions[i];
                let E_field;
                if (x <= -xp) {
                    E_field = 0;
                } else if (x <= 0) {
                    E_field = -(q * dep.NA / eps) * (x + xp); // V/m
                } else if (x <= xn) {
                    E_field = (q * dep.ND / eps) * (x - xn); // V/m
                } else {
                    E_field = 0;
                }
                efield_Vcm.push(E_field / 100); // V/m -> V/cm
            }
            
            // Determine good unit for E-field
            const E_max_Vcm = Math.abs(Math.min(...efield_Vcm));
            let efieldLabel, efieldScaled;
            if (E_max_Vcm > 1e6) {
                efieldLabel = 'Electric Field (MV/cm)';
                efieldScaled = efield_Vcm.map(e => e / 1e6);
            } else if (E_max_Vcm > 1e3) {
                efieldLabel = 'Electric Field (kV/cm)';
                efieldScaled = efield_Vcm.map(e => e / 1e3);
            } else {
                efieldLabel = 'Electric Field (V/cm)';
                efieldScaled = efield_Vcm;
            }
            
            // -- Potential chart --
            if (potentialChart) potentialChart.destroy();
            const ctxP = document.getElementById('potentialChart').getContext('2d');
            potentialChart = new Chart(ctxP, {
                type: 'line',
                data: {
                    labels: pos_um,
                    datasets: [
                        {
                            label: 'φ(x)',
                            data: phi_data,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37,99,235,0.1)',
                            borderWidth: 2.5,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.2
                        },
                        {
                            label: 'φ_bi',
                            data: pos_um.map(() => Vbi_eff),
                            borderColor: '#dc2626',
                            borderWidth: 1.5,
                            borderDash: [6, 4],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: ctx => 'x = ' + parseFloat(ctx[0].label).toFixed(4) + ' μm',
                                label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(4) + ' V'
                            }
                        },
                        annotation: {
                            annotations: createDepletionAnnotations(dep)
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Position (μm)' },
                            grid: { color: '#e5e7eb' },
                            ticks: {
                                callback: function(value) {
                                    if (Math.abs(value) < xp_um * 0.05) return '0';
                                    return value.toFixed(3);
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Potential φ (V)' },
                            grid: { color: '#e5e7eb' },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // -- Electric field chart --
            if (efieldChart) efieldChart.destroy();
            const ctxE = document.getElementById('efieldChart').getContext('2d');
            efieldChart = new Chart(ctxE, {
                type: 'line',
                data: {
                    labels: pos_um,
                    datasets: [
                        {
                            label: 'E(x)',
                            data: efieldScaled,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220,38,38,0.1)',
                            borderWidth: 2.5,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: ctx => 'x = ' + parseFloat(ctx[0].label).toFixed(4) + ' μm',
                                label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2)
                            }
                        },
                        annotation: {
                            annotations: createDepletionAnnotations(dep)
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Position (μm)' },
                            grid: { color: '#e5e7eb' },
                            ticks: {
                                callback: function(value) {
                                    if (Math.abs(value) < xp_um * 0.05) return '0';
                                    return value.toFixed(3);
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: efieldLabel },
                            grid: { color: '#e5e7eb' }
                        }
                    }
                }
            });
            
            // Info text
            document.getElementById('potentialChartInfo').innerHTML = `
                <p style="font-weight: 600;">φ<sub>bi</sub> = ${Vbi_eff.toFixed(4)} V | W = ${(dep.W * 1e6).toFixed(4)} μm | <span style="color: #9333ea;">x<sub>p</sub> = ${xp_um.toFixed(4)} μm</span> | <span style="color: #2563eb;">x<sub>n</sub> = ${xn_um.toFixed(4)} μm</span> | E<sub>max</sub> = ${(dep.E_max/100).toExponential(2)} V/cm</p>
            `;
        }
        
        function updateInfo(calc) {
            const varshniInfo = document.getElementById('varshniInfo');
            varshniInfo.innerHTML = `
                <span class="info-label">E<sub>g</sub>(0):</span><span>${calc.mat.Eg0.toFixed(4)} eV</span>
                <span class="info-label">α:</span><span>${calc.mat.alpha.toExponential(2)} eV/K</span>
                <span class="info-label">β:</span><span>${calc.mat.beta} K</span>
                <span class="info-label" style="color: #2563eb;">E<sub>g</sub>(${calc.temperature}K):</span><span style="color: #2563eb; font-weight: 600;">${calc.Eg.toFixed(4)} eV</span>
                <span class="info-label">kT:</span><span>${calc.kT.toFixed(5)} eV</span>
                <span class="info-label">n<sub>i</sub>:</span><span>${calc.ni.toExponential(2)} cm⁻³</span>
            `;
            
            const energyInfo = document.getElementById('energyInfo');
            let energyHTML = `
                <span class="info-label">E<sub>c</sub> (Conduction):</span><span>${calc.Ec.toFixed(4)} eV</span>
                <span class="info-label">E<sub>v</sub> (Valence):</span><span>${calc.Ev.toFixed(4)} eV</span>
                <span class="info-label">E<sub>i</sub> (Intrinsic):</span><span>${calc.Ei.toFixed(4)} eV</span>
                <span class="info-label" style="color: #059669;">E<sub>F,n</sub> (n-side):</span><span style="color: #059669;">${calc.Ef_n.toFixed(4)} eV</span>
                <span class="info-label" style="color: #dc2626;">E<sub>F,p</sub> (p-side):</span><span style="color: #dc2626;">${calc.Ef_p.toFixed(4)} eV</span>
                <span class="info-label">V<sub>bi</sub> (Built-in):</span><span>${calc.Vbi.toFixed(4)} V</span>
            `;
            if (calc.showQuasiFermi) {
                energyHTML += `<span class="info-label" style="color: #9333ea;">E<sub>Fn</sub> split:</span><span style="color: #9333ea;">${calc.forwardBias.toFixed(4)} V</span>`;
            }
            energyInfo.innerHTML = energyHTML;
            
            const nDopant = document.getElementById('nDopant').value;
            const pDopant = document.getElementById('pDopant').value;
            document.getElementById('chartInfo').innerHTML = `
                <p style="font-weight: 600;">Material: ${calc.mat.name} | Temperature: ${calc.temperature} K | Bandgap: ${calc.Eg.toFixed(4)} eV</p>
                <p>N-type: ${nDopant} (${calc.nConc.toExponential(1)} cm⁻³) | P-type: ${pDopant} (${calc.pConc.toExponential(1)} cm⁻³)</p>
            `;
        }
        
        function updateChart(calc) {
            const points = 100;
            const positions = [];
            const Ec_data = [];
            const Ev_data = [];
            const Ef_data = [];
            const Ei_data = [];
            const Efn_data = [];
            const Efp_data = [];
            
            for (let i = 0; i <= points; i++) {
                const x = (i / points) * 2 - 1;
                positions.push(x);
                
                let Ec_bent, Ev_bent, Ef, Efn, Efp;
                
                if (x < 0) {
                    const bend = Math.abs(x) < 0.2 ? (1 - Math.abs(x) / 0.2) * calc.Vbi / 2 : 0;
                    Ec_bent = calc.Ec - bend;
                    Ev_bent = calc.Ev - bend;
                    Ef = calc.Ef_n - bend;
                    Efn = calc.showQuasiFermi ? calc.Efn_n - bend : null;
                    Efp = calc.showQuasiFermi ? calc.Efp_n - bend : null;
                } else {
                    const bend = Math.abs(x) < 0.2 ? (1 - Math.abs(x) / 0.2) * calc.Vbi / 2 : calc.Vbi / 2;
                    Ec_bent = calc.Ec - calc.Vbi / 2 + bend;
                    Ev_bent = calc.Ev - calc.Vbi / 2 + bend;
                    Ef = calc.Ef_p - calc.Vbi / 2 + bend;
                    Efn = calc.showQuasiFermi ? calc.Efn_p - calc.Vbi / 2 + bend : null;
                    Efp = calc.showQuasiFermi ? calc.Efp_p - calc.Vbi / 2 + bend : null;
                }
                
                Ec_data.push(Ec_bent);
                Ev_data.push(Ev_bent);
                Ef_data.push(Ef);
                Ei_data.push(calc.Ei - (x < 0 ? 0 : calc.Vbi / 2) + (Math.abs(x) < 0.2 ? (1 - Math.abs(x) / 0.2) * calc.Vbi / 2 : (x < 0 ? 0 : calc.Vbi / 2)));
                Efn_data.push(Efn);
                Efp_data.push(Efp);
            }
            
            const datasets = [
                {
                    label: 'Conduction Band (Ec)',
                    data: Ec_data,
                    borderColor: '#2563eb',
                    backgroundColor: '#2563eb',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.4
                },
                {
                    label: 'Valence Band (Ev)',
                    data: Ev_data,
                    borderColor: '#dc2626',
                    backgroundColor: '#dc2626',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.4
                },
                {
                    label: 'Intrinsic Level (Ei)',
                    data: Ei_data,
                    borderColor: '#9333ea',
                    backgroundColor: '#9333ea',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0.4
                }
            ];
            
            if (!calc.showQuasiFermi) {
                datasets.push({
                    label: 'Fermi Level (Ef)',
                    data: Ef_data,
                    borderColor: '#059669',
                    backgroundColor: '#059669',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                });
            } else {
                datasets.push({
                    label: 'Quasi-Fermi (electrons)',
                    data: Efn_data,
                    borderColor: '#0891b2',
                    backgroundColor: '#0891b2',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    tension: 0.4
                });
                datasets.push({
                    label: 'Quasi-Fermi (holes)',
                    data: Efp_data,
                    borderColor: '#f59e0b',
                    backgroundColor: '#f59e0b',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    tension: 0.4
                });
            }
            
            if (chart) {
                chart.destroy();
            }
            
            const ctx = document.getElementById('bandChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: positions,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return 'Position: ' + context[0].label;
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + ' eV';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Position'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === 0) return 'Junction';
                                    if (value < 0) return 'n-side';
                                    return 'p-side';
                                }
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Energy (eV)'
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }
        
        function updateCalculations(calc) {
            const showCalc = document.getElementById('showCalculations').checked;
            const section = document.getElementById('calculationsSection');
            section.style.display = showCalc ? 'block' : 'none';
            if (!showCalc) return;
            
            const mat = calc.mat;
            const T = calc.temperature;
            const nDopant = document.getElementById('nDopant').value;
            const pDopant = document.getElementById('pDopant').value;
            const Ed = mat.donorEnergies[nDopant];
            const Ea = mat.acceptorEnergies[pDopant];
            const er = eps_r[currentMaterial];
            const epsVal = eps0 * er;
            
            // Recompute intermediates for display
            const Nc_T = mat.Nc * Math.pow(T / 300, 1.5);
            const Nv_T = mat.Nv * Math.pow(T / 300, 1.5);
            const dep = calculateDepletionParams(calc);
            
            const fmtE = (v) => v.toExponential(4);
            const fmt4 = (v) => v.toFixed(4);
            const fmt5 = (v) => v.toFixed(5);
            const fmtE2 = (v) => v.toExponential(2);
            
            let html = '';
            
            // ── SELECTED SETTINGS ──
            html += `<div class="calc-section">
                <h3>1. Selected Settings</h3>
                <table class="settings-table">
                    <tr><td>Substrate Material</td><td>${mat.name} (${currentMaterial})</td></tr>
                    <tr><td>Temperature (T)</td><td>${T} K</td></tr>
                    <tr><td>N-type Dopant</td><td>${nDopant} &nbsp; (E<sub>d</sub> = ${Ed} eV below E<sub>c</sub>)</td></tr>
                    <tr><td>P-type Dopant</td><td>${pDopant} &nbsp; (E<sub>a</sub> = ${Ea} eV above E<sub>v</sub>)</td></tr>
                    <tr><td>Donor Concentration (N<sub>D</sub>)</td><td>${fmtE2(calc.nConc)} cm⁻³</td></tr>
                    <tr><td>Acceptor Concentration (N<sub>A</sub>)</td><td>${fmtE2(calc.pConc)} cm⁻³</td></tr>
                    <tr><td>Forward Bias (V<sub>a</sub>)</td><td>${fmt4(calc.forwardBias)} V</td></tr>
                    <tr><td>Show Quasi-Fermi Levels</td><td>${calc.showQuasiFermi ? 'Yes' : 'No'}</td></tr>
                </table>
            </div>`;
            
            // ── CONSTANTS USED ──
            html += `<div class="calc-section">
                <h3>2. Constants Used</h3>
                <table class="constants-table">
                    <tr><td>Boltzmann constant (k<sub>B</sub>)</td><td>8.617 × 10⁻⁵ eV/K</td></tr>
                    <tr><td>Elementary charge (q)</td><td>1.602 × 10⁻¹⁹ C</td></tr>
                    <tr><td>Vacuum permittivity (ε₀)</td><td>8.854 × 10⁻¹² F/m</td></tr>
                    <tr><td>Relative permittivity (ε<sub>r</sub>) for ${currentMaterial}</td><td>${er}</td></tr>
                    <tr><td>Permittivity ε = ε₀ · ε<sub>r</sub></td><td>${fmtE(epsVal)} F/m</td></tr>
                </table>
                <h4>Varshni Parameters for ${mat.name}</h4>
                <table class="constants-table">
                    <tr><td>E<sub>g</sub>(0)</td><td>${mat.Eg0} eV</td></tr>
                    <tr><td>α</td><td>${mat.alpha.toExponential(2)} eV/K</td></tr>
                    <tr><td>β</td><td>${mat.beta} K</td></tr>
                </table>
                <h4>Effective Density of States</h4>
                <table class="constants-table">
                    <tr><td>N<sub>c</sub>(300K) <span style="color:#6b7280;">[reference]</span></td><td>${fmtE2(mat.Nc)} cm⁻³</td></tr>
                    <tr><td>N<sub>v</sub>(300K) <span style="color:#6b7280;">[reference]</span></td><td>${fmtE2(mat.Nv)} cm⁻³</td></tr>
                    <tr><td>N<sub>c</sub>(${T}K) = N<sub>c</sub>(300K)·(T/300)<sup>3/2</sup></td><td style="color:#2563eb; font-weight:600;">${fmtE2(Nc_T)} cm⁻³</td></tr>
                    <tr><td>N<sub>v</sub>(${T}K) = N<sub>v</sub>(300K)·(T/300)<sup>3/2</sup></td><td style="color:#2563eb; font-weight:600;">${fmtE2(Nv_T)} cm⁻³</td></tr>
                </table>
            </div>`;
            
            // ── STEP-BY-STEP CALCULATIONS ──
            html += `<div class="calc-section">
                <h3>3. Step-by-Step Calculations</h3>`;
            
            // Step 3.1: Thermal voltage
            html += `<h4>3.1 Thermal Voltage</h4>
                <div class="calc-step">
                    <div class="formula">kT = k<sub>B</sub> · T</div>
                    <div class="substitution">kT = (8.617 × 10⁻⁵ eV/K) · (${T} K)</div>
                    <div class="result">kT = ${fmt5(calc.kT)} eV</div>
                </div>`;
            
            // Step 3.2: Bandgap (Varshni)
            const alphaT2 = mat.alpha * T * T;
            const TplusBeta = T + mat.beta;
            html += `<h4>3.2 Temperature-Dependent Bandgap (Varshni Equation)</h4>
                <div class="calc-step">
                    <div class="formula">E<sub>g</sub>(T) = E<sub>g</sub>(0) − α·T² / (T + β)</div>
                    <div class="substitution">E<sub>g</sub>(${T}) = ${mat.Eg0} − (${mat.alpha.toExponential(2)})(${T})² / (${T} + ${mat.beta})</div>
                    <div class="substitution">E<sub>g</sub>(${T}) = ${mat.Eg0} − ${fmtE(alphaT2)} / ${TplusBeta}</div>
                    <div class="substitution">E<sub>g</sub>(${T}) = ${mat.Eg0} − ${fmt4(alphaT2 / TplusBeta)}</div>
                    <div class="result">E<sub>g</sub>(${T}K) = ${fmt4(calc.Eg)} eV</div>
                </div>`;
            
            // Step 3.3: Temperature-scaled density of states
            const Tratio = T / 300;
            const Tratio32 = Math.pow(Tratio, 1.5);
            html += `<h4>3.3 Temperature-Scaled Effective Density of States</h4>
                <div class="calc-step">
                    <div class="formula">N<sub>c</sub>(T) = N<sub>c</sub>(300K) · (T/300)<sup>3/2</sup></div>
                    <div class="substitution">N<sub>c</sub>(${T}) = (${fmtE2(mat.Nc)}) · (${T}/300)<sup>3/2</sup></div>
                    <div class="substitution">N<sub>c</sub>(${T}) = (${fmtE2(mat.Nc)}) · (${fmt4(Tratio)})<sup>3/2</sup></div>
                    <div class="substitution">N<sub>c</sub>(${T}) = (${fmtE2(mat.Nc)}) · ${fmt4(Tratio32)}</div>
                    <div class="result">N<sub>c</sub>(${T}K) = ${fmtE2(Nc_T)} cm⁻³</div>
                </div>
                <div class="calc-step">
                    <div class="formula">N<sub>v</sub>(T) = N<sub>v</sub>(300K) · (T/300)<sup>3/2</sup></div>
                    <div class="substitution">N<sub>v</sub>(${T}) = (${fmtE2(mat.Nv)}) · ${fmt4(Tratio32)}</div>
                    <div class="result">N<sub>v</sub>(${T}K) = ${fmtE2(Nv_T)} cm⁻³</div>
                </div>`;
            
            // Step 3.4: Intrinsic carrier concentration
            const sqrtNcNv = Math.sqrt(Nc_T * Nv_T);
            const expArg = -calc.Eg / (2 * calc.kT);
            const expVal = Math.exp(expArg);
            html += `<h4>3.4 Intrinsic Carrier Concentration</h4>
                <div class="calc-step">
                    <div class="formula">n<sub>i</sub> = √(N<sub>c</sub> · N<sub>v</sub>) · exp(−E<sub>g</sub> / 2kT)</div>
                    <div class="substitution">n<sub>i</sub> = √((${fmtE2(Nc_T)})(${fmtE2(Nv_T)})) · exp(−${fmt4(calc.Eg)} / (2 × ${fmt5(calc.kT)}))</div>
                    <div class="substitution">n<sub>i</sub> = (${fmtE2(sqrtNcNv)}) · exp(${fmt4(expArg)})</div>
                    <div class="substitution">n<sub>i</sub> = (${fmtE2(sqrtNcNv)}) · (${fmtE(expVal)})</div>
                    <div class="result">n<sub>i</sub> = ${fmtE2(calc.ni)} cm⁻³</div>
                </div>`;
            
            // Step 3.5: Energy band references
            html += `<h4>3.5 Energy Band Reference Levels</h4>
                <div class="calc-step">
                    <div class="label">Setting the valence band edge as the energy reference:</div>
                    <div class="result">E<sub>v</sub> = ${fmt4(calc.Ev)} eV &nbsp; (reference)</div>
                    <div class="formula">E<sub>c</sub> = E<sub>v</sub> + E<sub>g</sub></div>
                    <div class="result">E<sub>c</sub> = ${fmt4(calc.Ev)} + ${fmt4(calc.Eg)} = ${fmt4(calc.Ec)} eV</div>
                    <div class="formula">E<sub>i</sub> = E<sub>g</sub> / 2</div>
                    <div class="result">E<sub>i</sub> = ${fmt4(calc.Eg)} / 2 = ${fmt4(calc.Ei)} eV</div>
                </div>`;
            
            // Step 3.6: Fermi levels
            const logArgN = Nc_T / calc.nConc;
            const lnN = Math.log(logArgN);
            const logArgP = Nv_T / calc.pConc;
            const lnP = Math.log(logArgP);
            html += `<h4>3.6 Fermi Level Positions</h4>
                <div class="calc-step">
                    <div class="label">N-side Fermi level (from conduction band):</div>
                    <div class="formula">E<sub>F,n</sub> = E<sub>c</sub> − kT · ln(N<sub>c</sub>(T) / N<sub>D</sub>)</div>
                    <div class="substitution">E<sub>F,n</sub> = ${fmt4(calc.Ec)} − (${fmt5(calc.kT)}) · ln(${fmtE2(Nc_T)} / ${fmtE2(calc.nConc)})</div>
                    <div class="substitution">E<sub>F,n</sub> = ${fmt4(calc.Ec)} − (${fmt5(calc.kT)}) · ln(${fmtE(logArgN)})</div>
                    <div class="substitution">E<sub>F,n</sub> = ${fmt4(calc.Ec)} − (${fmt5(calc.kT)}) · (${fmt4(lnN)})</div>
                    <div class="substitution">E<sub>F,n</sub> = ${fmt4(calc.Ec)} − ${fmt4(calc.kT * lnN)}</div>
                    <div class="result">E<sub>F,n</sub> = ${fmt4(calc.Ef_n)} eV</div>
                </div>
                <div class="calc-step">
                    <div class="label">P-side Fermi level (from valence band):</div>
                    <div class="formula">E<sub>F,p</sub> = E<sub>v</sub> + kT · ln(N<sub>v</sub>(T) / N<sub>A</sub>)</div>
                    <div class="substitution">E<sub>F,p</sub> = ${fmt4(calc.Ev)} + (${fmt5(calc.kT)}) · ln(${fmtE2(Nv_T)} / ${fmtE2(calc.pConc)})</div>
                    <div class="substitution">E<sub>F,p</sub> = ${fmt4(calc.Ev)} + (${fmt5(calc.kT)}) · ln(${fmtE(logArgP)})</div>
                    <div class="substitution">E<sub>F,p</sub> = ${fmt4(calc.Ev)} + (${fmt5(calc.kT)}) · (${fmt4(lnP)})</div>
                    <div class="substitution">E<sub>F,p</sub> = ${fmt4(calc.Ev)} + ${fmt4(calc.kT * lnP)}</div>
                    <div class="result">E<sub>F,p</sub> = ${fmt4(calc.Ef_p)} eV</div>
                </div>`;
            
            // Step 3.7: Built-in potential
            html += `<h4>3.7 Built-in Potential</h4>
                <div class="calc-step">
                    <div class="formula">V<sub>bi</sub> = E<sub>F,n</sub> − E<sub>F,p</sub></div>
                    <div class="substitution">V<sub>bi</sub> = ${fmt4(calc.Ef_n)} − ${fmt4(calc.Ef_p)}</div>
                    <div class="result">V<sub>bi</sub> = ${fmt4(calc.Vbi)} V</div>
                </div>`;
            
            // Step 3.8: Effective built-in potential under bias
            html += `<h4>3.8 Effective Built-in Potential Under Bias</h4>
                <div class="calc-step">
                    <div class="formula">V<sub>bi,eff</sub> = V<sub>bi</sub> − V<sub>a</sub></div>
                    <div class="substitution">V<sub>bi,eff</sub> = ${fmt4(calc.Vbi)} − ${fmt4(calc.forwardBias)}</div>
                    <div class="result">V<sub>bi,eff</sub> = ${fmt4(dep.Vbi_eff)} V</div>
                </div>`;
            
            // Step 3.9: Depletion region
            const ND_m3 = dep.ND;
            const NA_m3 = dep.NA;
            const invSum = 1/NA_m3 + 1/ND_m3;
            html += `<h4>3.9 Depletion Region Width</h4>
                <div class="calc-step">
                    <div class="label">Convert doping to SI units (m⁻³):</div>
                    <div class="substitution">N<sub>D</sub> = ${fmtE2(calc.nConc)} cm⁻³ = ${fmtE2(ND_m3)} m⁻³</div>
                    <div class="substitution">N<sub>A</sub> = ${fmtE2(calc.pConc)} cm⁻³ = ${fmtE2(NA_m3)} m⁻³</div>
                </div>
                <div class="calc-step">
                    <div class="formula">W = √( 2ε · V<sub>bi,eff</sub> / q · (1/N<sub>A</sub> + 1/N<sub>D</sub>) )</div>
                    <div class="substitution">W = √( 2 · (${fmtE(epsVal)}) · (${fmt4(dep.Vbi_eff)}) / (${fmtE(q)}) · (1/${fmtE2(NA_m3)} + 1/${fmtE2(ND_m3)}) )</div>
                    <div class="substitution">W = √( ${fmtE(2 * epsVal * dep.Vbi_eff / q)} · ${fmtE(invSum)} )</div>
                    <div class="substitution">W = √( ${fmtE(2 * epsVal * dep.Vbi_eff / q * invSum)} )</div>
                    <div class="result">W = ${fmtE(dep.W)} m = ${fmt4(dep.W * 1e6)} μm</div>
                </div>`;
            
            // Step 3.10: Depletion partitioning
            html += `<h4>3.10 Depletion Width Partitioning</h4>
                <div class="calc-step">
                    <div class="label">Depletion extends further into the lighter-doped side:</div>
                    <div class="formula">x<sub>p</sub> = W · N<sub>D</sub> / (N<sub>A</sub> + N<sub>D</sub>)</div>
                    <div class="substitution">x<sub>p</sub> = (${fmtE(dep.W)}) · (${fmtE2(ND_m3)}) / (${fmtE2(NA_m3)} + ${fmtE2(ND_m3)})</div>
                    <div class="substitution">x<sub>p</sub> = (${fmtE(dep.W)}) · ${fmt4(ND_m3 / (NA_m3 + ND_m3))}</div>
                    <div class="result">x<sub>p</sub> = ${fmtE(dep.xp)} m = ${fmt4(dep.xp * 1e6)} μm</div>
                </div>
                <div class="calc-step">
                    <div class="formula">x<sub>n</sub> = W · N<sub>A</sub> / (N<sub>A</sub> + N<sub>D</sub>)</div>
                    <div class="substitution">x<sub>n</sub> = (${fmtE(dep.W)}) · (${fmtE2(NA_m3)}) / (${fmtE2(NA_m3)} + ${fmtE2(ND_m3)})</div>
                    <div class="substitution">x<sub>n</sub> = (${fmtE(dep.W)}) · ${fmt4(NA_m3 / (NA_m3 + ND_m3))}</div>
                    <div class="result">x<sub>n</sub> = ${fmtE(dep.xn)} m = ${fmt4(dep.xn * 1e6)} μm</div>
                </div>`;
            
            // Step 3.11: Peak electric field
            html += `<h4>3.11 Peak Electric Field</h4>
                <div class="calc-step">
                    <div class="formula">E<sub>max</sub> = q · N<sub>A</sub> · x<sub>p</sub> / ε</div>
                    <div class="substitution">E<sub>max</sub> = (${fmtE(q)}) · (${fmtE2(NA_m3)}) · (${fmtE(dep.xp)}) / (${fmtE(epsVal)})</div>
                    <div class="result">E<sub>max</sub> = ${fmtE(dep.E_max)} V/m = ${fmtE2(dep.E_max / 100)} V/cm</div>
                </div>
                <div class="calc-step">
                    <div class="label">Verification via N<sub>D</sub> side:</div>
                    <div class="formula">E<sub>max</sub> = q · N<sub>D</sub> · x<sub>n</sub> / ε</div>
                    <div class="substitution">E<sub>max</sub> = (${fmtE(q)}) · (${fmtE2(ND_m3)}) · (${fmtE(dep.xn)}) / (${fmtE(epsVal)})</div>
                    <div class="result">E<sub>max</sub> = ${fmtE(q * ND_m3 * dep.xn / epsVal)} V/m ✓</div>
                </div>`;
            
            // Step 3.12: Electrostatic potential profile
            html += `<h4>3.12 Electrostatic Potential Profile (Depletion Approximation)</h4>
                <div class="calc-step">
                    <div class="label">P-side depletion (−x<sub>p</sub> ≤ x ≤ 0):</div>
                    <div class="formula">φ(x) = q·N<sub>A</sub> / (2ε) · (x + x<sub>p</sub>)²</div>
                    <div class="label" style="margin-top: 8px;">N-side depletion (0 ≤ x ≤ x<sub>n</sub>):</div>
                    <div class="formula">φ(x) = V<sub>bi,eff</sub> − q·N<sub>D</sub> / (2ε) · (x − x<sub>n</sub>)²</div>
                    <div class="label" style="margin-top: 8px;">Neutral regions:</div>
                    <div class="formula">φ(x) = 0 &nbsp; for x &lt; −x<sub>p</sub></div>
                    <div class="formula">φ(x) = V<sub>bi,eff</sub> &nbsp; for x &gt; x<sub>n</sub></div>
                </div>`;
            
            // Step 3.13: Electric field profile
            html += `<h4>3.13 Electric Field Profile (Depletion Approximation)</h4>
                <div class="calc-step">
                    <div class="label">P-side depletion (−x<sub>p</sub> ≤ x ≤ 0):</div>
                    <div class="formula">E(x) = −q·N<sub>A</sub>/ε · (x + x<sub>p</sub>)</div>
                    <div class="label" style="margin-top: 8px;">N-side depletion (0 ≤ x ≤ x<sub>n</sub>):</div>
                    <div class="formula">E(x) = q·N<sub>D</sub>/ε · (x − x<sub>n</sub>)</div>
                    <div class="label" style="margin-top: 8px;">Neutral regions:</div>
                    <div class="formula">E(x) = 0 &nbsp; for |x| outside depletion region</div>
                    <div class="label" style="margin-top: 8px;">At the junction (x = 0):</div>
                    <div class="substitution">E(0) = −q·N<sub>A</sub>·x<sub>p</sub>/ε = −${fmtE(dep.E_max)} V/m</div>
                    <div class="result">|E<sub>max</sub>| = ${fmtE2(dep.E_max)} V/m = ${fmtE2(dep.E_max / 100)} V/cm</div>
                </div>`;
            
            // Step 3.14: Quasi-Fermi levels (if enabled)
            if (calc.showQuasiFermi) {
                html += `<hr class="calc-divider">
                    <h4>3.14 Quasi-Fermi Level Splitting Under Forward Bias</h4>
                    <div class="calc-step">
                        <div class="label">Under forward bias V<sub>a</sub> = ${fmt4(calc.forwardBias)} V, the Fermi level splits into separate quasi-Fermi levels for electrons and holes:</div>
                        <div class="formula" style="margin-top: 8px;">E<sub>Fn</sub> − E<sub>Fp</sub> = qV<sub>a</sub> = ${fmt4(calc.forwardBias)} eV</div>
                    </div>
                    <div class="calc-step">
                        <div class="label">On the n-side (majority electrons):</div>
                        <div class="formula">E<sub>Fn</sub> (n-side) = E<sub>F,n</sub> = ${fmt4(calc.Efn_n)} eV</div>
                        <div class="formula">E<sub>Fp</sub> (n-side) = E<sub>F,n</sub> − qV<sub>a</sub></div>
                        <div class="substitution">E<sub>Fp</sub> (n-side) = ${fmt4(calc.Ef_n)} − ${fmt4(calc.forwardBias)}</div>
                        <div class="result">E<sub>Fp</sub> (n-side) = ${fmt4(calc.Efp_n)} eV</div>
                    </div>
                    <div class="calc-step">
                        <div class="label">On the p-side (majority holes):</div>
                        <div class="formula">E<sub>Fp</sub> (p-side) = E<sub>F,p</sub> = ${fmt4(calc.Efp_p)} eV</div>
                        <div class="formula">E<sub>Fn</sub> (p-side) = E<sub>F,p</sub> + qV<sub>a</sub></div>
                        <div class="substitution">E<sub>Fn</sub> (p-side) = ${fmt4(calc.Ef_p)} + ${fmt4(calc.forwardBias)}</div>
                        <div class="result">E<sub>Fn</sub> (p-side) = ${fmt4(calc.Efn_p)} eV</div>
                    </div>`;
            }
            
            html += `</div>`; // close calc-section
            
            document.getElementById('calculationsContent').innerHTML = html;
        }
        
        function update() {
            const calc = calculate();
            updateInfo(calc);
            updateChart(calc);
            updatePotentialChart(calc);
            updateCalculations(calc);
            
            document.getElementById('quasiFermiHelp').style.display = calc.showQuasiFermi ? 'list-item' : 'none';
        }
        
        // Event listeners
        document.getElementById('material').addEventListener('change', function() {
            currentMaterial = this.value;
            updateDopantOptions();
            update();
        });
        
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
            update();
        });
        
        document.getElementById('nConc').addEventListener('input', function() {
            const value = Math.pow(10, parseFloat(this.value));
            document.getElementById('nConcValue').textContent = value.toExponential(2);
            update();
        });
        
        document.getElementById('pConc').addEventListener('input', function() {
            const value = Math.pow(10, parseFloat(this.value));
            document.getElementById('pConcValue').textContent = value.toExponential(2);
            update();
        });
        
        document.getElementById('forwardBias').addEventListener('input', function() {
            document.getElementById('biasValue').textContent = parseFloat(this.value).toFixed(3);
            update();
        });
        
        document.getElementById('showQuasiFermi').addEventListener('change', update);
        document.getElementById('showCalculations').addEventListener('change', update);
        document.getElementById('nDopant').addEventListener('change', update);
        document.getElementById('pDopant').addEventListener('change', update);
        
        // Initialize
        updateDopantOptions();
        update();
    </script>
</body>
</html>
